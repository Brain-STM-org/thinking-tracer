<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <!-- CSP: restrict sources; unsafe-inline needed for Vite HMR in dev, production build can be stricter -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' ws: wss:; worker-src 'self' blob:;" />
    <title>Thinking Tracer</title>
  </head>
  <body>
    <!-- Chart tooltip (shared) -->
    <div id="chart-tooltip">
      <span class="tooltip-turn">Turn 1</span>: <span class="tooltip-value">0</span>
    </div>

    <div id="app">
      <!-- Toolbar -->
      <div id="toolbar">
        <button id="toolbar-back" title="Back to file selection">&larr;</button>
        <button id="sidebar-toggle" title="Toggle Sidebar">&#9776;</button>
        <div class="toolbar-divider"></div>
        <div id="toolbar-title">Thinking Tracer</div>
        <div id="toolbar-meta"></div>
        <div class="toolbar-spacer"></div>
        <div class="view-mode-group">
          <button class="view-mode-btn" data-mode="3d" title="3D View Only">3D</button>
          <button class="view-mode-btn active" data-mode="split" title="Split View">Split</button>
          <button class="view-mode-btn" data-mode="conversation" title="Conversation Only">Conv</button>
        </div>
        <div class="export-dropdown">
          <button id="export-btn" title="Export Conversation" disabled>Export</button>
          <div class="export-menu">
            <button data-format="html">Export as HTML</button>
            <button data-format="markdown">Export as Markdown</button>
          </div>
        </div>
      </div>

      <!-- Main container -->
      <div id="main-container">
        <!-- Sidebar -->
        <div id="sidebar">
          <!-- Search Bar (always visible at top, outside scrollable area) -->
          <div id="sidebar-search">
              <div class="search-input-row">
                <input type="text" id="search-input" placeholder="Search... (/)">
                <button id="search-regex-toggle" title="Toggle regex mode (case-insensitive)">.*</button>
              </div>
              <div class="search-filters">
                <label class="search-filter">
                  <input type="checkbox" data-type="user" checked>
                  <span class="filter-color user"></span>
                  <span>User</span>
                </label>
                <label class="search-filter">
                  <input type="checkbox" data-type="assistant" checked>
                  <span class="filter-color assistant"></span>
                  <span>Asst</span>
                </label>
                <label class="search-filter">
                  <input type="checkbox" data-type="thinking" checked>
                  <span class="filter-color thinking"></span>
                  <span>Think</span>
                </label>
                <label class="search-filter">
                  <input type="checkbox" data-type="tool_use" checked>
                  <span class="filter-color tool-use"></span>
                  <span>Tool</span>
                </label>
                <label class="search-filter">
                  <input type="checkbox" data-type="tool_result" checked>
                  <span class="filter-color tool-result"></span>
                  <span>Result</span>
                </label>
              </div>
              <div id="search-results-count"></div>
              <div id="search-results-list"></div>
              <div class="search-nav">
                <button id="search-prev" title="Previous (Shift+Enter)">&#8593; Prev</button>
                <button id="search-next" title="Next (Enter)">Next &#8595;</button>
                <button id="search-clear" title="Clear (Esc)">Clear</button>
              </div>
            </div>

          <!-- Scrollable sidebar content -->
          <div id="sidebar-content">
            <!-- Metrics Section -->
            <div class="sidebar-section expanded" data-section="metrics">
              <div class="sidebar-section-header">
                <span class="arrow">&#9658;</span>
                <h3>Metrics</h3>
                <span class="metrics-range"><span id="chart-range">1-N</span></span>
              </div>
              <div class="sidebar-section-content">
                <div id="metrics-stack">
                  <div class="metric-row" data-metric="totalTokens">
                    <span class="metric-label">Tokens</span>
                    <div class="metric-chart-container"><canvas class="metric-canvas"></canvas></div>
                    <span class="metric-total">0</span>
                  </div>
                  <div class="metric-row" data-metric="outputTokens">
                    <span class="metric-label">Output</span>
                    <div class="metric-chart-container"><canvas class="metric-canvas"></canvas></div>
                    <span class="metric-total">0</span>
                  </div>
                  <div class="metric-row" data-metric="inputTokens">
                    <span class="metric-label">Input</span>
                    <div class="metric-chart-container"><canvas class="metric-canvas"></canvas></div>
                    <span class="metric-total">0</span>
                  </div>
                  <div class="metric-row" data-metric="thinkingCount">
                    <span class="metric-label">Thinking</span>
                    <div class="metric-chart-container"><canvas class="metric-canvas"></canvas></div>
                    <span class="metric-total">0</span>
                  </div>
                  <div class="metric-row" data-metric="toolCount">
                    <span class="metric-label">Tools</span>
                    <div class="metric-chart-container"><canvas class="metric-canvas"></canvas></div>
                    <span class="metric-total">0</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Words Section -->
            <div class="sidebar-section expanded" data-section="words">
              <div class="sidebar-section-header">
                <span class="arrow">&#9658;</span>
                <h3>Top Words</h3>
              </div>
              <div class="sidebar-section-content">
                <div id="word-freq-header">
                  <select id="word-freq-source">
                    <option value="all">All Content</option>
                    <option value="user">User Only</option>
                    <option value="assistant">Assistant Only</option>
                    <option value="thinking">Thinking Only</option>
                  </select>
                </div>
                <div id="word-freq-chart"></div>
              </div>
            </div>

            <!-- Details Section -->
            <div class="sidebar-section expanded" data-section="details">
              <div class="sidebar-section-header">
                <span class="arrow">&#9658;</span>
                <h3>Details</h3>
              </div>
              <div class="sidebar-section-content">
                <div id="detail-panel-content">
                  <div class="detail-empty">&lt;no selection&gt;</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="sidebar-resize"></div>

        <!-- Content area -->
        <div id="content-area">
          <div id="canvas-pane">
            <div id="canvas-container"></div>
            <div id="legend">
              <div id="legend-header">
                <span>Legend</span>
                <span id="legend-toggle">▼</span>
              </div>
              <div id="legend-body">
                <div class="legend-section">
                  <h3>Node Types</h3>
                  <div class="legend-item">
                    <div class="legend-color user"></div>
                    <span class="legend-label">User</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color assistant"></div>
                    <span class="legend-label">Assistant</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color thinking"></div>
                    <span class="legend-label">Thinking</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color tool-use"></div>
                    <span class="legend-label">Tool call</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color tool-result"></div>
                    <span class="legend-label">Tool result</span>
                  </div>
                </div>
                <div class="legend-section">
                  <h3>Camera</h3>
                  <div class="legend-shortcut"><kbd>Drag</kbd> Rotate</div>
                  <div class="legend-shortcut"><kbd>Shift+Drag</kbd> Pan</div>
                  <div class="legend-shortcut"><kbd>Scroll</kbd> Zoom</div>
                  <div class="legend-shortcut"><kbd>H</kbd> Home view</div>
                  <div class="legend-shortcut"><kbd>R</kbd> Reset view</div>
                </div>
                <div class="legend-section">
                  <h3>Navigation</h3>
                  <div class="legend-shortcut"><kbd>←</kbd><kbd>→</kbd> Prev/Next turn</div>
                  <div class="legend-shortcut"><kbd>Enter</kbd> Expand/Collapse</div>
                  <div class="legend-shortcut"><kbd>Home</kbd><kbd>End</kbd> First/Last</div>
                </div>
              </div>
            </div>
            <div id="canvas-controls">
              <button id="expand-toggle" title="Toggle Expand/Collapse All">Expand</button>
              <button id="watch-toggle" title="Watch file for live updates (Chromium only)">Watch</button>
              <button id="coil-controls-toggle" title="Toggle Coil Controls">Coil</button>
            </div>
            <div id="coil-controls">
              <div id="coil-controls-header">
                <span>Coil Parameters</span>
                <button id="coil-reset-btn" title="Reset to defaults">Reset</button>
              </div>
              <div id="coil-controls-body">
                <div class="coil-toggle-row">
                  <label>
                    <input type="checkbox" id="cluster-lines-toggle" checked>
                    <span>Show cluster lines</span>
                  </label>
                  <div class="coil-line-options visible" id="cluster-line-options">
                    <div class="coil-line-option">
                      <label>Color</label>
                      <input type="color" id="cluster-line-color" value="#b7410e">
                      <span class="coil-value color-code" id="cluster-line-color-value">#B7410E</span>
                    </div>
                    <div class="coil-line-option">
                      <label>Width</label>
                      <input type="range" id="cluster-line-width" min="1" max="50" step="1" value="6">
                      <span class="coil-value" id="cluster-line-width-value">6</span>
                    </div>
                    <div class="coil-line-option">
                      <label>Opacity</label>
                      <input type="range" id="cluster-line-opacity" min="0.1" max="1" step="0.05" value="0.4">
                      <span class="coil-value" id="cluster-line-opacity-value">0.40</span>
                    </div>
                  </div>
                </div>
                <div class="coil-section">
                  <div class="coil-section-title">Primary Spiral</div>
                  <div class="coil-slider" data-param="spiralRadius">
                    <label>Radius</label>
                    <input type="range" min="0.5" max="8" step="0.1">
                    <span class="coil-value">2.5</span>
                  </div>
                  <div class="coil-slider" data-param="spiralAngleStep">
                    <label>Angle</label>
                    <input type="range" min="0.2" max="3.14" step="0.05">
                    <span class="coil-value">1.26</span>
                  </div>
                </div>
                <div class="coil-section">
                  <div class="coil-section-title">Secondary Coil</div>
                  <div class="coil-slider" data-param="coilRadius">
                    <label>Radius</label>
                    <input type="range" min="0" max="15" step="0.5">
                    <span class="coil-value">6</span>
                  </div>
                  <div class="coil-slider" data-param="coilAngleStep">
                    <label>Angle</label>
                    <input type="range" min="0" max="1.5" step="0.02">
                    <span class="coil-value">0.39</span>
                  </div>
                  <div class="coil-slider" data-param="coilVerticalStep">
                    <label>V-Step</label>
                    <input type="range" min="0" max="5" step="0.1">
                    <span class="coil-value">1.5</span>
                  </div>
                </div>
                <div class="coil-section">
                  <div class="coil-section-title">Slinky Effect</div>
                  <div class="coil-slider" data-param="focusRadius">
                    <label>Focus</label>
                    <input type="range" min="1" max="20" step="1">
                    <span class="coil-value">4</span>
                  </div>
                  <div class="coil-slider" data-param="minVerticalSpacing">
                    <label>Min Gap</label>
                    <input type="range" min="0" max="2" step="0.05">
                    <span class="coil-value">0.2</span>
                  </div>
                  <div class="coil-slider" data-param="maxVerticalSpacing">
                    <label>Max Gap</label>
                    <input type="range" min="0.5" max="5" step="0.1">
                    <span class="coil-value">1.5</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id="split-handle"></div>
          <div id="conversation-pane">
            <div id="conversation-header">
              <div id="conversation-header-top">
                <h3>Conversation</h3>
                <span id="conversation-turn-indicator"></span>
              </div>
              <div id="conversation-filters">
                <button class="conv-filter active" data-filter="user">User</button>
                <button class="conv-filter active" data-filter="output">Output</button>
                <button class="conv-filter" data-filter="thinking">Thinking</button>
                <button class="conv-filter" data-filter="tools">Tools</button>
              </div>
            </div>
            <div id="conversation-content"></div>
          </div>
        </div>
      </div>

      <!-- Drop overlay -->
      <div id="drop-overlay" class="visible">
        <div class="drop-header">
          <h1 class="drop-title">Thinking Tracer</h1>
          <p class="drop-intro">Explore Claude's reasoning process in 3D. Visualize conversation traces to understand thinking patterns, tool usage, and response flow. Export conversations to HTML or Markdown.</p>
          <a href="https://github.com/brain-stm-org/thinking-tracer" target="_blank" class="github-link" title="View on GitHub">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
              <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
            </svg>
            <span>GitHub</span>
          </a>
        </div>

        <!-- Screenshot with Try Sample overlay -->
        <div id="try-sample-btn" class="sample-preview">
          <img src="etc/images/screenshot.png" alt="Example visualization" class="sample-preview-img">
          <div class="sample-preview-overlay">
            <span class="sample-preview-btn">See How This Was Built</span>
          </div>
        </div>

        <!-- File selection row -->
        <div class="file-select-row">
          <div class="drop-zone">
            <div class="drop-icon">&#128193;</div>
            <div class="drop-text">Drop a conversation file</div>
            <div class="drop-subtext">Supports Claude Code .jsonl trace files</div>
          </div>
          <div class="drop-divider-vertical"></div>
          <div class="file-select-zone">
            <button id="file-select-btn">Select File</button>
            <div class="drop-subtext">Browse your files</div>
          </div>
        </div>
        <input type="file" id="file-input" accept=".json,.jsonl,.json.gz,.jsonl.gz,.json.zst,.jsonl.zst,.json.zstd,.jsonl.zstd">

        <div id="recent-traces" class="hidden">
          <div class="recent-header">
            <h3>Recent Traces</h3>
            <button class="recent-clear-btn" id="recent-clear-btn">Clear All</button>
          </div>
          <div class="recent-list" id="recent-list"></div>
          <div class="recent-footer">Stored locally in your browser</div>
        </div>
      </div>

      <div id="stats"></div>
    </div>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
